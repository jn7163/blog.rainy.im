<!DOCTYPE html>
<html lang="cn">

<head>
      <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html" charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />


  <title>JWT 在前后端分离中的应用与实践</title>


  <meta name="HandheldFriendly" content="True" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="referrer" content="origin" />
  <meta name="generator" content="Pelican" />
  <link href="http://blog.rainy.im/" rel="canonical" />

  <!-- Feed -->
        <link href="http://blog.rainy.im/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Yu's Tech Lab Full Atom Feed" />
          <link href="http://blog.rainy.im/feeds/go.atom.xml" type="application/atom+xml" rel="alternate" title="Yu's Tech Lab Categories Atom Feed" />

  <link href="http://blog.rainy.im/theme/css/style.css" type="text/css" rel="stylesheet" />

  <!-- Code highlight color scheme -->
      <link href="http://blog.rainy.im/theme/css/code_blocks/github.css" rel="stylesheet">


  <!-- Custom fonts -->
  <link href='https://fonts.googleapis.com/css?family=Montserrat:400,300' rel='stylesheet' type='text/css' />
  <link href="https://fonts.googleapis.com/css?family=Lato" rel="stylesheet" type="text/css" />

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
    <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
  <![endif]-->


    <link href="http://blog.rainy.im/2015/06/10/react-jwt-pretty-good-practice/" rel="canonical" />


        <meta name="author" content="Yusheng">

        <meta name="tags" content="Go">
        <meta name="tags" content="React">
        <meta name="tags" content="前后端分离">
        <meta name="tags" content="JWT">




<!-- Open Graph -->
<meta property="og:site_name" content="Yu's Tech Lab"/>
<meta property="og:title" content="JWT 在前后端分离中的应用与实践"/>
<meta property="og:description" content=""/>
<meta property="og:locale" content="en_US"/>
<meta property="og:url" content="http://blog.rainy.im/2015/06/10/react-jwt-pretty-good-practice/"/>
<meta property="og:type" content="article"/>
<meta property="article:published_time" content="2015-06-10 13:19:56+08:00"/>
<meta property="article:modified_time" content="2015-06-10 13:19:56+08:00"/>
<meta property="article:author" content="http://blog.rainy.im/author/yusheng.html">
<meta property="article:section" content="Go"/>
<meta property="article:tag" content="Go"/>
<meta property="article:tag" content="React"/>
<meta property="article:tag" content="前后端分离"/>
<meta property="article:tag" content="JWT"/>
<meta property="og:image" content="http://blog.rainy.im/theme/images/post-bg.jpg">

<!-- Twitter Card -->

<script type="application/ld+json">
{
  "@context": "http://schema.org",
  "@type": "Article",
  "name": "JWT 在前后端分离中的应用与实践",
  "headline": "JWT 在前后端分离中的应用与实践",
  "datePublished": "2015-06-10 13:19:56+08:00",
  "dateModified": "2015-06-10 13:19:56+08:00",
  "author": {
    "@type": "Person",
    "name": "Yusheng",
    "url": "http://blog.rainy.im/author/yusheng.html"
  },
  "image": "http://blog.rainy.im/theme/images/post-bg.jpg",
  "url": "http://blog.rainy.im/2015/06/10/react-jwt-pretty-good-practice/",
  "description": ""
}
</script>
</head>
<!-- TODO : Body class -->
<body class="home-template">

<nav id="menu">
  <a class="close-button">Close</a>
  <div class="nav-wrapper">
    <p class="nav-label">Menu</p>
    <ul>


    </ul>
  </div>
</nav>
    <!-- Progressbar -->
    <div class="progress-container">
        <span class="progress-bar"></span>
    </div>

    <!-- Page Header -->
    <!-- Set your background image for this header on the line below. -->
    <header id="post-header" class="has-cover">
      <div class="inner">
        <nav id="navigation">
            <span id="home-button" class="nav-button">
                <a class="home-button" href="http://blog.rainy.im/" title="Home"><i class="ic ic-arrow-left"></i> Home</a>
            </span>
          <span id="menu-button" class="nav-button">
            <a class="menu-button"><i class="ic ic-menu"></i> Menu</a>
          </span>
        </nav>
        <h1 class="post-title">JWT 在前后端分离中的应用与实践</h1>
        <!-- TODO : Proper class for headline -->
        <span class="post-meta">
                <a href="http://blog.rainy.im/author/yusheng.html">Yusheng</a>
            | <time datetime="Wed 10 June 2015">Wed 10 June 2015</time>
        </span>
        <!-- TODO : Modified check -->
            <span class="post-meta"> | Updated on Wed 10 June 2015</span>
            <div class="post-cover cover" style="background-image: url('http://blog.rainy.im/theme/images/post-bg.jpg')">
      </div>
    </header>

  <section id="wrapper">
    <a class="hidden-close"></a>

    <!-- Post content -->
    <main class="content" role="main">
        <article class="post">
        <div class="inner">
            <section class="post-content">
                <p>本文主要介绍JWT（[JSON Web Token]）授权机制在前后端分离中的应用与实践，包括以下三部分：</p>
<ol>
<li>JWT原理介绍</li>
<li>JWT的安全性</li>
<li>React.js+Flux架构下的实践（[React-jwt example]</li>
</ol>
<p>本文主要介绍JWT（<a href="http://jwt.io/">JSON Web Token</a>）授权机制在前后端分离中的应用与实践，包括以下三部分：</p>
<ol>
<li>JWT原理介绍</li>
<li>JWT的安全性</li>
<li>React.js+Flux架构下的实践（<a href="https://github.com/rainyear/react-jwt-example.git">React-jwt example</a>）</li>
</ol>
<h3>0 关于前后端分离</h3>
<p>前后端分离是一个很有趣的议题，它不仅仅是指前后端工程师之间的相互独立的合作分工方式，更是前后端之间开发模式与交互模式的模块化、解耦化。计算机世界的经验告诉我们，对于复杂的事物，模块化总是好的，无论是后端API开发中越来越成为规范的<a href="http://en.wikipedia.org/wiki/Representational_state_transfer">RESTful API</a>风格，还是Web前端越来越多的模板、框架（参见<a href="http://www.ruanyifeng.com/blog/2015/02/mvcmvp_mvvm.html">MVC，MVP 和 MVVM 的图示</a>），包括移动应用中前后端天然分离的特质，都证实了前后端分离的重要性与必要性（更生动的细节与实例说明可以参看赫门分享的主题<a href="http://2014.jsconf.cn/slides/herman-taobaoweb/#/">淘宝前后端分离实践</a>）。</p>
<p>实现前后端分离，对于后端开发人员来说是一件很幸福的事情，因为不需要再考虑怎样在HTML中套入数据，只关心数据逻辑的处理；而前端则需要承担接收数据之后界面呈现、用户交互、数据传递等所有任务。虽然这看起来加重了前端的工作量，但实际上有越来越多丰富多样的前端框架可供选择，这让前端开发变得越来越结构化、系统化，前端工程师也不再只是“套版的”。</p>
<p>在所有前端框架中，Facebook推出的<a href="http://facebook.github.io/react">React</a>无疑是当下最热门（之一），然而React只负责界面渲染层面，相当于MVC中的V（View），因此只靠React无法完成一个完整的单页应用（<a href="http://en.wikipedia.org/wiki/Single-page_application">Single Page App</a>）。Facebook另外推出与之配套的<a href="http://facebook.github.io/flux">Flux</a>架构，主要为了避免Angular.js之类MVC的架构模式，规避数据双向绑定而采用单向绑定的数据传递方式。实际上React无论是学习还是使用都是非常简单的，而Flux则需要花更多时间去理解消化，本文第3部分我采用Flux架构的一种实现<a href="https://github.com/spoike/refluxjs">Reflux.js</a>，做了一个基于JWT授权机制的登入、登出的例子，顺便介绍Flux架构的细节。</p>
<h3>1 JWT 介绍及其原理</h3>
<p>JWT是我之前做Android应用的时候了解到的一种用户授权机制，虽然原生的移动手机应用与基于浏览器的Web应用之间存在很多差异，但很多情况下后端往往还是沿用已有的架构跟代码，所以用户授权往往还是采用Cookie+Session的方式，也就是需要原生应用中模拟浏览器对Cookie的操作。</p>
<p>Cookie+Session的存在主要是为了解决HTTP这一无状态协议下服务器如何识别用户的问题，其原理就是在用户登录通过验证后，服务端将数据加密后保存到客户端浏览器的Cookie中，同时服务器保留相对应的Session（文件或DB）。用户之后发起的请求都会携带Cookie信息，服务端需要根据Cookie寻回对应的Session，从而完成验证，确认这是之前登陆过的用户。其工作原理如下图所示：</p>
<p><img alt="Cookie+Session" src="http://7xiijd.com1.z0.glb.clouddn.com/cookie_sessions.png"></p>
<p>JWT是<a href="https://auth0.com/">Auth0</a>提出的通过对JSON进行加密签名来实现授权验证的方案，编码之后的JWT看起来是这样的一串字符：</p>
<div class="highlight"><pre>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJzdWIiOiIxMjM0NTY3ODkwIiwibmFtZSI6IkpvaG4gRG9lIiwiYWRtaW4iOnRydWV9.TJVA95OrM7E2cBab30RMHrHDcEfxjoYZgeFONFh7HgQ
</pre></div>


<p>由<code>.</code>分为三段，通过解码可以得到：</p>
<div class="highlight"><pre><span class="c1">// 1. Headers</span>
<span class="c1">// 包括类别（typ）、加密算法（alg）；</span>
<span class="p">{</span>
  <span class="s2">&quot;alg&quot;</span><span class="o">:</span> <span class="s2">&quot;HS256&quot;</span><span class="p">,</span>
  <span class="s2">&quot;typ&quot;</span><span class="o">:</span> <span class="s2">&quot;JWT&quot;</span>
<span class="p">}</span>
<span class="c1">// 2. Claims</span>
<span class="c1">// 包括需要传递的用户信息；</span>
<span class="p">{</span>
  <span class="s2">&quot;sub&quot;</span><span class="o">:</span> <span class="s2">&quot;1234567890&quot;</span><span class="p">,</span>
  <span class="s2">&quot;name&quot;</span><span class="o">:</span> <span class="s2">&quot;John Doe&quot;</span><span class="p">,</span>
  <span class="s2">&quot;admin&quot;</span><span class="o">:</span> <span class="kc">true</span>
<span class="p">}</span>
<span class="c1">// 3. Signature</span>
<span class="c1">// 根据alg算法与私有秘钥进行加密得到的签名字串；</span>
<span class="c1">// 这一段是最重要的敏感信息，只能在服务端解密；</span>
<span class="nx">HMACSHA256</span><span class="p">(</span>
    <span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">header</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span>
    <span class="nx">base64UrlEncode</span><span class="p">(</span><span class="nx">payload</span><span class="p">),</span>
    <span class="nx">SECREATE_KEY</span>
<span class="p">)</span>
</pre></div>


<p>在使用过程中，服务端通过用户登录验证之后，将Header+Claim信息加密后得到第三段签名，然后将签名返回给客户端，在后续请求中，服务端只需要对用户请求中包含的JWT进行解码，即可验证是否可以授权用户获取相应信息，其原理如下图所示：</p>
<p><img alt="JWT" src="http://7xiijd.com1.z0.glb.clouddn.com/json_web_token.png"></p>
<p>通过比较可以看出，使用JWT可以省去服务端读取Session的步骤，这样更符合RESTful的规范。但是对于客户端（或App端）来说，为了保存用户授权信息，仍然需要通过Cookie或类似的机制进行本地保存。因此JWT是用来取代服务端的Session而非客户端Cookie的方案，当然对于客户端本地存储，HTML5提供了Cookie之外更多的解决方案（localStorage/sessionStorage），究竟采用哪种存储方式，其实从Js操作上来看没有本质上的差异，不同的选择更多是出于安全性的考虑。</p>
<h3>2 JWT 安全性</h3>
<p>用户授权这样敏感的信息，安全性当然是首先需要考虑的因素。这里主要讨论在使用JWT时如何防止XSS和XSRF两种攻击。</p>
<p>XSS是Web中最常见的一种漏洞（我们的**学报官网就存在这个漏洞这件事我就不说了=.=），其主要原因是对用户输入信息不加过滤，导致用户（被误导）恶意输入的Js代码在访问该网页时被执行，而Js可以读取当前网站域名下保存的Cookie信息。针对这种攻击，无论是Cookie还是localStorage中的信息都有可能被窃取，但防止XSS也相对简单一些，对用户输入的所有信息进行过滤即可。另外，现在越来越多的CDN服务，让我们可以节省服务器流量，但同时也有可能引入不安全的Js脚本，例如前段时间Github被Great Cannon轰击的案例，则需要提高对某度之类服务的警惕。</p>
<p>另外一种更加棘手的XSRF漏洞主要利用Cookie是按照域名存储，同时访问某域名时浏览器会自动携带该域名所保存的Cookie信息这一特征。如果执意要将JWT存储在Cookie中，服务端则需要额外验证请求来源，或者在提交表单中加入随机签名并在处理表单时进行验证。</p>
<p>我在后面的实例中采用将JWT保存在localStorage中的方案，请求时将JWT放入Request Header中的Authorization位。对JWT安全性问题想要了解更多可以参考下面几篇文章：</p>
<ol>
<li><a href="https://stormpath.com/blog/where-to-store-your-jwts-cookies-vs-html5-web-storage/">Where to Store Your JWTs - Cookies vs HTML5 Web Storage</a></li>
<li><a href="https://stormpath.com/blog/jwt-the-right-way/">Use JWT the Right Way!</a></li>
<li><a href="https://auth0.com/blog/2014/01/27/ten-things-you-should-know-about-tokens-and-cookies/">10 Things You Should Know about Tokens</a></li>
<li><a href="http://stackoverflow.com/questions/27067251/where-to-store-jwt-in-browser-how-to-protect-against-csrf">Where to store JWT in browser? How to protect against CSRF?</a></li>
</ol>
<h3>3 React-jwt Example</h3>
<p>本节源码可见<a href="https://github.com/rainyear/react-jwt-example">Github: react-jwt-example</a>。</p>
<p>前面提到的React.js框架学习成本其实非常低，只要跟着官方教程走一遍，搞清楚props、states、virtual DOM几个概念，就可以开始用了。但是只有View层什么都做不了，Facebook推出配套的Flux架构，一开始看到下面这张架构图，当时我就懵逼了。</p>
<p><img alt="Flux diagram" src="http://7xiijd.com1.z0.glb.clouddn.com/flux-diagram-white-background.png"></p>
<p>好在Flux只是一种理论架构，虽然官方也提供了实现方案，但是我更倾向于<a href="https://github.com/spoike/refluxjs">Reflux.js</a>的实现方式，如下图所示：</p>
<p><img alt="Reflux.js" src="http://7xiijd.com1.z0.glb.clouddn.com/reflux.png"></p>
<p>其中View Components即视图层由React负责，Stores用于存储数据，Actions则用于监听所有动作，所有数据的传递都是单向绑定的，在分割不同模块时，可以清楚地看到数据的流动方向。</p>
<p>我尝试写了一个简单的登录、登出以及获取用户个人数据的例子，除了Reflux之外，还用到如下模块：</p>
<ol>
<li><a href="https://github.com/rackt/react-router">react-router</a>: SPA路由；</li>
<li><a href="http://react-bootstrap.github.io/">react-bootstrap</a>: React化的Bootstrap，UI样式；</li>
<li><a href="https://www.npmjs.com/package/reqwest">reqwest</a>: Ajax请求；</li>
<li><a href="https://www.npmjs.com/package/jwt-decode">jwt-decode</a>: 客户端的JWT解码；</li>
</ol>
<p>另外服务端API采用<a href="https://gin-gonic.github.io/gin">Go gin</a>框架，依赖于<a href="http://github.com/dgrijalva/jwt-go">jwt-go</a>。代码目录结构如下：</p>
<div class="highlight"><pre>tree -I <span class="s1">&#39;node_modules|.git&#39;</span>
.
├── README.md
├── gulpfile.js
├── index.html
├── package.json
├── scripts
│   ├── actions
│   │   └── actions.js
│   ├── app.js
│   ├── build
│   │   └── dist.js
│   ├── components
│   │   └── HelloWorld.js
│   ├── stores
│   │   ├── loginStore.js
│   │   └── userStore.js
│   └── views
│       ├── home.js
│       ├── login.js
│       └── profile.js
└── server.go
</pre></div>


<p>完整的页面放在view中，可复用的组件放在components，用户的动作包括login、logout以及getBalance，因此需要创建相应的action来监听这些动作：</p>
<div class="highlight"><pre><span class="c1">// actions.js</span>
<span class="kd">var</span> <span class="nx">actions</span> <span class="o">=</span> <span class="nx">Reflux</span><span class="p">.</span><span class="nx">createActions</span><span class="p">({</span>
  <span class="s2">&quot;login&quot;</span><span class="o">:</span> <span class="p">{},</span>
  <span class="s2">&quot;updateProfile&quot;</span><span class="o">:</span> <span class="p">{},</span> <span class="c1">// login成功更新用户数据</span>
  <span class="s2">&quot;loginError&quot;</span><span class="o">:</span> <span class="p">{},</span> <span class="c1">// login失败错误信息</span>
  <span class="s2">&quot;logout&quot;</span><span class="o">:</span> <span class="p">{},</span>
  <span class="s2">&quot;getBalance&quot;</span><span class="o">:</span> <span class="p">{</span><span class="nx">asyncResult</span><span class="o">:</span> <span class="kc">true</span><span class="p">}</span>
<span class="p">});</span>

<span class="nx">actions</span><span class="p">.</span><span class="nx">login</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){});</span>
</pre></div>


<p>用户点击view中的Submit Button时，将表单信息提交给login action：</p>
<div class="highlight"><pre><span class="c1">// views/login.js</span>
<span class="kd">var</span> <span class="nx">Login</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
  <span class="p">...</span>
  <span class="nx">login</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">e</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">e</span><span class="p">.</span><span class="nx">preventDefault</span><span class="p">();</span>
    <span class="nx">actions</span><span class="p">.</span><span class="nx">login</span><span class="p">({</span>
      <span class="nx">name</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">.</span><span class="nx">name</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(),</span>
      <span class="nx">pass</span><span class="o">:</span> <span class="k">this</span><span class="p">.</span><span class="nx">refs</span><span class="p">.</span><span class="nx">pass</span><span class="p">.</span><span class="nx">getValue</span><span class="p">(),</span>
    <span class="p">}),</span>
  <span class="p">...</span>
<span class="p">});</span>
<span class="c1">// actions.js</span>
<span class="kd">var</span> <span class="nx">req</span>    <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">&#39;reqwest&#39;</span><span class="p">);</span>
<span class="nx">actions</span><span class="p">.</span><span class="nx">login</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">data</span><span class="p">){</span>
  <span class="nx">req</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">HOST</span><span class="o">+</span><span class="s2">&quot;/user/token&quot;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
    <span class="nx">data</span><span class="o">:</span> <span class="nx">JSON</span><span class="p">.</span><span class="nx">stringify</span><span class="p">(</span><span class="nx">data</span><span class="p">),</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s1">&#39;json&#39;</span><span class="p">,</span>
    <span class="nx">contentType</span><span class="o">:</span> <span class="s1">&#39;application/json&#39;</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span><span class="s1">&#39;X-Requested-With&#39;</span><span class="o">:</span> <span class="s1">&#39;XMLHttpRequest&#39;</span><span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">){</span>
        <span class="nx">actions</span><span class="p">.</span><span class="nx">updateProfile</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">jwt</span><span class="p">)</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">actions</span><span class="p">.</span><span class="nx">updateProfile</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">msg</span><span class="p">)</span>
      <span class="p">}</span>
    <span class="p">},</span>
  <span class="p">})</span>
<span class="p">});</span>
</pre></div>


<p>根据API返回结果，将再次触发updateProfile或updateProfile action，而分别由userStore和loginStore接收：</p>
<div class="highlight"><pre><span class="c1">// stores/userStore.js</span>
<span class="kd">var</span> <span class="nx">userStore</span> <span class="o">=</span> <span class="nx">Reflux</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="nx">listenables</span><span class="o">:</span> <span class="nx">actions</span><span class="p">,</span> <span class="c1">// 声明userStore所监听的action</span>
  <span class="nx">updateProfile</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">jwt</span><span class="p">){</span>
    <span class="c1">// 注册监听actions.updateProfile</span>
    <span class="nx">localStorage</span><span class="p">.</span><span class="nx">setItem</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">,</span> <span class="nx">jwt</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">user</span> <span class="o">=</span> <span class="nx">jwt_decode</span><span class="p">(</span><span class="nx">jwt</span><span class="p">);</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">logd</span> <span class="o">=</span> <span class="kc">true</span><span class="p">;</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="k">this</span><span class="p">.</span><span class="nx">user</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">})</span>
<span class="c1">// stores/loginStore.js</span>
<span class="kd">var</span> <span class="nx">loginStore</span> <span class="o">=</span> <span class="nx">Reflux</span><span class="p">.</span><span class="nx">createStore</span><span class="p">({</span>
  <span class="nx">listenables</span><span class="o">:</span> <span class="nx">actions</span><span class="p">,</span>
  <span class="nx">loginError</span><span class="o">:</span> <span class="kd">function</span><span class="p">(</span><span class="nx">msg</span><span class="p">){</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="nx">msg</span><span class="p">);</span>
  <span class="p">},</span>
<span class="p">});</span>
</pre></div>


<p>store接收action数据后，通过<code>this.trigger(msg)</code>将处理过后的数据重新传递会view：</p>
<div class="highlight"><pre><span class="kd">var</span> <span class="nx">Login</span> <span class="o">=</span> <span class="nx">React</span><span class="p">.</span><span class="nx">createClass</span><span class="p">({</span>
  <span class="nx">mixins</span> <span class="o">:</span> <span class="p">[</span>
    <span class="nx">Router</span><span class="p">.</span><span class="nx">Navigation</span><span class="p">,</span>
    <span class="nx">Reflux</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="nx">userStore</span><span class="p">,</span> <span class="s1">&#39;onLoginSucc&#39;</span><span class="p">),</span>
    <span class="nx">Reflux</span><span class="p">.</span><span class="nx">listenTo</span><span class="p">(</span><span class="nx">loginStore</span><span class="p">,</span> <span class="s1">&#39;onLoginErr&#39;</span><span class="p">)</span>
  <span class="p">],</span>
  <span class="nx">onLoginSucc</span><span class="o">:</span> <span class="kd">function</span><span class="p">(){</span>
    <span class="c1">// 登录成功，跳转回首页</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">transitionTo</span><span class="p">(</span><span class="s1">&#39;home&#39;</span><span class="p">);</span>
  <span class="p">},</span>
  <span class="nx">onLoginErr</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">msg</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// 登录失败，显示错误信息</span>
    <span class="k">this</span><span class="p">.</span><span class="nx">setState</span><span class="p">({</span>
      <span class="nx">errorMsg</span><span class="o">:</span> <span class="nx">msg</span><span class="p">,</span> 
    <span class="p">});</span>
  <span class="p">},</span>
  <span class="p">...</span>
<span class="p">});</span>
</pre></div>


<p>至此，从用户点击登录到登录结果传回，整个流程数据在<code>View-&gt;Action-&gt;Store-&gt;View</code>中完成单向传递，这就是Flux架构的基本概念。</p>
<p>在完成登录后，API会将验证通过的JWT传回：</p>
<div class="highlight"><pre><span class="c1">// server.go</span>
<span class="nx">token</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">New</span><span class="p">(</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">SigningMethodHS256</span><span class="p">)</span>
<span class="c1">// Headers</span>
<span class="nx">token</span><span class="p">.</span><span class="nx">Header</span><span class="p">[</span><span class="s">&quot;alg&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;HS256&quot;</span>
<span class="nx">token</span><span class="p">.</span><span class="nx">Header</span><span class="p">[</span><span class="s">&quot;typ&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="s">&quot;JWT&quot;</span>
<span class="c1">// Claims</span>
<span class="nx">token</span><span class="p">.</span><span class="nx">Claims</span><span class="p">[</span><span class="s">&quot;name&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">validUser</span><span class="p">.</span><span class="nx">Name</span>
<span class="nx">token</span><span class="p">.</span><span class="nx">Claims</span><span class="p">[</span><span class="s">&quot;mail&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">validUser</span><span class="p">.</span><span class="nx">Mail</span>
<span class="nx">token</span><span class="p">.</span><span class="nx">Claims</span><span class="p">[</span><span class="s">&quot;exp&quot;</span><span class="p">]</span> <span class="p">=</span> <span class="nx">time</span><span class="p">.</span><span class="nx">Now</span><span class="p">().</span><span class="nx">Add</span><span class="p">(</span><span class="nx">time</span><span class="p">.</span><span class="nx">Hour</span> <span class="o">*</span> <span class="mi">72</span><span class="p">).</span><span class="nx">Unix</span><span class="p">()</span>
<span class="nx">tokenString</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">token</span><span class="p">.</span><span class="nx">SignedString</span><span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">mySigningKey</span><span class="p">))</span>
<span class="k">if</span> <span class="nx">err</span> <span class="o">!=</span> <span class="kc">nil</span> <span class="p">{</span>
  <span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="mi">500</span><span class="p">,</span> <span class="s">&quot;msg&quot;</span><span class="p">:</span> <span class="s">&quot;Server error!&quot;</span><span class="p">})</span>
  <span class="k">return</span>
<span class="p">}</span>
<span class="nx">c</span><span class="p">.</span><span class="nx">JSON</span><span class="p">(</span><span class="mi">200</span><span class="p">,</span> <span class="nx">gin</span><span class="p">.</span><span class="nx">H</span><span class="p">{</span><span class="s">&quot;code&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s">&quot;msg&quot;</span><span class="p">:</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="s">&quot;jwt&quot;</span><span class="p">:</span> <span class="nx">tokenString</span><span class="p">})</span>
</pre></div>


<p>当登录之后的用户在profile页面发起getBalance请求时，存储于本地的jwt将一起传递，我这里采用Header的方式传递，具体取决于API端的协议：</p>
<div class="highlight"><pre><span class="c1">// actions.js</span>
<span class="nx">actions</span><span class="p">.</span><span class="nx">getBalance</span><span class="p">.</span><span class="nx">listen</span><span class="p">(</span><span class="kd">function</span><span class="p">(){</span>
  <span class="kd">var</span> <span class="nx">jwt</span> <span class="o">=</span> <span class="nx">localStorage</span><span class="p">.</span><span class="nx">getItem</span><span class="p">(</span><span class="s1">&#39;jwt&#39;</span><span class="p">);</span>
  <span class="nx">req</span><span class="p">({</span>
    <span class="nx">url</span><span class="o">:</span> <span class="nx">HOST</span><span class="o">+</span><span class="s2">&quot;/user/balance&quot;</span><span class="p">,</span>
    <span class="nx">method</span><span class="o">:</span> <span class="s2">&quot;post&quot;</span><span class="p">,</span>
    <span class="nx">type</span><span class="o">:</span> <span class="s2">&quot;json&quot;</span><span class="p">,</span>
    <span class="nx">headers</span><span class="o">:</span> <span class="p">{</span>
      <span class="s1">&#39;Authorization&#39;</span><span class="o">:</span> <span class="s2">&quot;Bearer &quot;</span><span class="o">+</span><span class="nx">jwt</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="nx">success</span><span class="o">:</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">resp</span><span class="p">)</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">code</span> <span class="o">==</span> <span class="mi">200</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">actions</span><span class="p">.</span><span class="nx">updateProfile</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">jwt</span><span class="p">);</span>
      <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="nx">actions</span><span class="p">.</span><span class="nx">loginError</span><span class="p">(</span><span class="nx">resp</span><span class="p">.</span><span class="nx">msg</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">})</span>
<span class="p">})</span>
</pre></div>


<p>而服务端面对任何需要验证权限的请求需要通过Token验证：</p>
<div class="highlight"><pre><span class="c1">//server.go</span>
<span class="nx">token</span><span class="p">,</span> <span class="nx">err</span> <span class="o">:=</span> <span class="nx">jwt</span><span class="p">.</span><span class="nx">ParseFromRequest</span><span class="p">(</span><span class="nx">c</span><span class="p">.</span><span class="nx">Request</span><span class="p">,</span> <span class="kd">func</span><span class="p">(</span><span class="nx">token</span> <span class="o">*</span><span class="nx">jwt</span><span class="p">.</span><span class="nx">Token</span><span class="p">)</span> <span class="p">(</span><span class="kd">interface</span><span class="p">{},</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
  <span class="nx">b</span> <span class="o">:=</span> <span class="p">([]</span><span class="nb">byte</span><span class="p">(</span><span class="nx">mySigningKey</span><span class="p">))</span>
  <span class="k">return</span> <span class="nx">b</span><span class="p">,</span> <span class="kc">nil</span>
<span class="p">})</span>
</pre></div>


<p><a href="https://www.coinbase.com/rainyear"><img alt="BitCoin donate button" src="https://img.shields.io/badge/Bitcoin-donate-2b71b1.svg?style=flat"></a> <a href="https://github.com/rainyear/lolita/wiki/Donation#tenpay"><img alt="Tenpay donate button" src="https://img.shields.io/badge/Tenpay-donate-brightgreen.svg?style=flat"></a> <a href="https://github.com/rainyear/lolita/wiki/Donation#alipay"><img alt="Alipay donate button" src="https://img.shields.io/badge/Alipay-donate-orange.svg?style=flat"></a></p>
            </section>

            <section class="post-info">
                <div class="post-share">
                    <a class="twitter" href="https://twitter.com/share?text=JWT 在前后端分离中的应用与实践&amp;url=http://blog.rainy.im/2015/06/10/react-jwt-pretty-good-practice/" onclick="window.open(this.href, 'twitter-share', 'width=550,height=235');return false;">
                    <i class="ic ic-twitter"></i><span class="hidden">Twitter</span>
                    </a>
                    <a class="facebook" href="https://www.facebook.com/sharer/sharer.php?u=http://blog.rainy.im/2015/06/10/react-jwt-pretty-good-practice/" onclick="window.open(this.href, 'facebook-share','width=580,height=296');return false;">
                    <i class="ic ic-facebook"></i><span class="hidden">Facebook</span>
                    </a>
                    <a class="googleplus" href="https://plus.google.com/share?url=http://blog.rainy.im/2015/06/10/react-jwt-pretty-good-practice/" onclick="window.open(this.href, 'google-plus-share', 'width=490,height=530');return false;">
                    <i class="ic ic-googleplus"></i><span class="hidden">Google+</span>
                    </a>
                    <div class="clear"></div>
                </div>

                <aside class="post-tags">
<a href="http://blog.rainy.im/tag/go.html">Go</a><a href="http://blog.rainy.im/tag/react.html">React</a><a href="http://blog.rainy.im/tag/qian-hou-duan-fen-chi.html">前后端分离</a><a href="http://blog.rainy.im/tag/jwt.html">JWT</a>                </aside>

                <div class="clear"></div>


                </section>


                <aside class="post-nav">
                    <div class="clear"></div>
                </aside>

            </div>
        </article>
    </main>
      <!-- TODO : Body class -->
    <div id="body-class" style="display: none;" class=""></div>

    <footer id="footer">
      <div class="inner">
        <section class="credits">


          <span class="credits-theme">Theme <a href="https://github.com/arulrajnet/attila" rel="nofollow">Attila</a></span>
          <span class="credits-software">Published with <a href="https://github.com/getpelican/pelican" rel="nofollow">Pelican</a></span>
        </section>
      </div>
    </footer>
  </section>

  <script type="text/javascript" src="http://blog.rainy.im/theme/js/script.js"></script>

</body>
</html>